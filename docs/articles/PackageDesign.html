<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Package Design • ResultModelManager</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Package Design">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ResultModelManager</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/CreatingMigrations.html">Creating Migrations</a></li>
    <li><a class="dropdown-item" href="../articles/ExampleProject.html">Example package results spec</a></li>
    <li><a class="dropdown-item" href="../articles/PackageDesign.html">Package Design</a></li>
    <li><a class="dropdown-item" href="../articles/UploadFunctionality.html">Upload Functionality</a></li>
    <li><a class="dropdown-item" href="../articles/UsingAnExportManager.html">Using An Export Manager</a></li>
    <li><a class="dropdown-item" href="../articles/UsingConnectionHandlers.html">Using Connection Handlers</a></li>
    <li><a class="dropdown-item" href="../articles/UsingPythonUploads.html">Using python for postrgresql uploads</a></li>
    <li><a class="dropdown-item" href="../articles/UsingQueryNamespaces.html">Using Query Namespaces</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="https://ohdsi.github.io/ResultModelManager"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/ResultModelManager/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Package Design</h1>
                        <h4 data-toc-skip class="author">James P.
Gilbert</h4>
            
            <h4 data-toc-skip class="date">2025-09-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/ResultModelManager/blob/HEAD/vignettes/PackageDesign.Rmd" class="external-link"><code>vignettes/PackageDesign.Rmd</code></a></small>
      <div class="d-none name"><code>PackageDesign.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>ResultModelManager is a package that aims to standardize the handling
of data models across OHDSI Hades packages. This package is designed to
have minimal requirements and be easily imported by others.</p>
<div class="section level3">
<h3 id="problem-statement">Problem statement<a class="anchor" aria-label="anchor" href="#problem-statement"></a>
</h3>
<p>At the time of writing, OHDSI analytics packages have many different
and specific results data models that can change between package
versions. When changes occur to these data models occurs, old versions
of dependent software become incompatible with new versions. Similarly,
when applications that depend on these data models encounter these
changes developers are either forced in to the following
assumptions:</p>
<ul>
<li>Old results will never work with new features</li>
<li>Old results cannot be easily “upgraded”</li>
<li>That new features of bug fixes to web applications can’t be applied
to old data</li>
<li>That users can generate new results - these may have been generated
by network studies</li>
<li>That results data models between two apps are immutable and cannot
be readily changed</li>
<li>That developers will have to make one-off ‘hacks’ to support fixes
to legacy results data models</li>
<li>That results generated at different times cannot be directly
compared without significant time to massage data into a common
format</li>
</ul>
<p>Furthermore, as the Strategus package is being developed it has been
noted that many existing analytics packages generate results that are in
non standard formats. Any time data models are changed, this breaks any
backwards compatibility.</p>
</div>
<div class="section level3">
<h3 id="package-name">Package name<a class="anchor" aria-label="anchor" href="#package-name"></a>
</h3>
<p>Work in progress name: ResultModelManager (RMM or, phonetically,
rum).</p>
</div>
<div class="section level3">
<h3 id="package-purpose">Package purpose<a class="anchor" aria-label="anchor" href="#package-purpose"></a>
</h3>
<p>This goal of package is intended to provide common data model
utilities that can be used across OHDSI packages. The initial focus will
be on handling database migrations via a common interface that can be
used within R packages to add new data models (where not existing),
handle migrations to future versions, report the status of a given data
model’s version, get migrations that are to be run and execute SQL
scripts that change a data model in sequential order.</p>
<p>In addition, common functionality for defining and querying data
models can be provided in a way that allows easier access to results
data models for the purpose of post-collection data analysis.</p>
<p>This is similar in function to a software utility like flyway (used
successfully in OHDSI WebAPI) - however, this is geared towards
<code>R</code> and the <code>OHDSI</code> landscape of packages, with
results that have been generated by ohdsi analytics packages and are
intended to be explored using OHDSI open source reporting tools such as
shiny and Rmarkdown. From analysis - it is not simple to expect users to
install flyway, and would not be trivial to store and handle migrations
in this way.</p>
</div>
<div class="section level3">
<h3 id="scope-and-intended-use">Scope and Intended Use<a class="anchor" aria-label="anchor" href="#scope-and-intended-use"></a>
</h3>
<p>This package only intends to provide utilities for R Ohdsi packages
that require exploration of results in a common way.</p>
<p>This package will mainly be used by OHDSI package maintainers and is
not intended for users of those software. Though some functionality
(such as alerting users to the fact that a data model is out of date) it
will be up to the package maintainers to implement the interfaces
provided here. In terms of Data model migrations and querying this
package will provide a series of abstract base classes/interfaces (note:
this distinction is hard to enforce within R6) that can be implemented
within individual packages. The packages themselves will create classes
that can perform the required tasks.</p>
</div>
</div>
<div class="section level2">
<h2 id="system-features-and-requirements">System Features and Requirements<a class="anchor" aria-label="anchor" href="#system-features-and-requirements"></a>
</h2>
<div class="section level3">
<h3 id="general">General<a class="anchor" aria-label="anchor" href="#general"></a>
</h3>
<div class="section level4">
<h4 id="package-dependencies">Package dependencies<a class="anchor" aria-label="anchor" href="#package-dependencies"></a>
</h4>
<p>The obvious initial dependencies are <code>ParrallelLogger</code>,
<code>R6</code>, <code>DatabaseConnector</code> and
<code>SqlRender</code>. Beyond this the package should be fairly
lightweight and should not require packages from outside CRAN. It is not
an initial requirement that this package is in CRAN but all development
should conform to this unless a requirement makes this impossible.</p>
</div>
</div>
<div class="section level3">
<h3 id="data-migration-manager-dmm-class">Data Migration Manager (DMM) Class<a class="anchor" aria-label="anchor" href="#data-migration-manager-dmm-class"></a>
</h3>
<p>The results migrator class will be defined as an <code>R6</code>
class that has the following base functions:</p>
<ul>
<li>Init with parameters</li>
<li>DatabaseConnector connection or connectionDetails object</li>
<li>results database schema</li>
<li>table prefix</li>
<li>Location of migration files (e.g. a package or relative path)</li>
<li>load migrations - return a data.frame of all migration file paths
and the order they are to be executed in</li>
<li>
<code>status()</code> Get the status of a current data model - this
should return the ordered migrations and flag those that have or haven’t
been executed</li>
<li>
<code>check()</code> Check that migrations conform to standards (can
be used in package tests)</li>
<li>
<code>executeMigrations()</code> execute any migrations that have
not been completed</li>
</ul>
<div class="section level4">
<h4 id="class-definition">Class definition<a class="anchor" aria-label="anchor" href="#class-definition"></a>
</h4>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DataMigrationManager</span> <span class="op">&lt;-</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span></span>
<span>  <span class="st">"DataMigrationManager"</span>,</span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    executeMigration <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">filePath</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Load, render, translate and execute sql</span></span>
<span></span>
<span>      <span class="co"># Save migration in set of migrations</span></span>
<span></span>
<span>      <span class="co"># Error handling - stop execution, restore transaction</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    migrationPath <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    migrationFolder <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    resulultsDatabaseSchema <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    connection <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    initalize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">connectionDetails</span>,</span>
<span>                         <span class="va">resultsDatabaseSchema</span>,</span>
<span>                         <span class="va">tablePrefix</span>,</span>
<span>                         <span class="va">migrationsPath</span>,</span>
<span>                         <span class="va">migrationRegexp</span> <span class="op">=</span> <span class="va">.defaultMigrationRegexp</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Set required variables</span></span>
<span>    <span class="op">}</span>,</span>
<span>    getStatus <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># return data frame all migrations, including file name, order and</span></span>
<span>    <span class="op">}</span>,</span>
<span>    check <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Check to see if files follow pattern</span></span>
<span>    <span class="op">}</span>,</span>
<span>    executeMigrations <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># load list of migrations</span></span>
<span>      <span class="co"># Load list of executed migrations</span></span>
<span>      <span class="co"># if migrations table doesn't exist, create it</span></span>
<span>      <span class="co"># execute migrations that haven't been executed yet</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-implementation-for-package">Example implementation for package<a class="anchor" aria-label="anchor" href="#example-implementation-for-package"></a>
</h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @inheritParams ResultModelManager::DatabaseMigrationManager - this will probably need to be a factory</span></span>
<span><span class="co">#' @export`</span></span>
<span><span class="va">getMigrationManager</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">migrationsPath</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sql"</span>, <span class="st">"sql_server"</span>, <span class="st">"migrations"</span>, package <span class="op">=</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/packageName.html" class="external-link">packageName</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">migrationManager</span> <span class="op">&lt;-</span> <span class="fu">ResultModelManager</span><span class="fu">::</span><span class="va">DatabaseMigrationManager</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>migrationsPath <span class="op">=</span> <span class="va">migrationsPath</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>It should also be possible to load the manager from a directory
structure outside of a package. However, this may have limitations when
considering the way sql files are loaded with SqlRender, especially when
including scripts that have platform specific changes.</p>
</div>
</div>
<div class="section level3">
<h3 id="proposed-structure-of-a-migration-sql-script">Proposed structure of a migration SQL script<a class="anchor" aria-label="anchor" href="#proposed-structure-of-a-migration-sql-script"></a>
</h3>
<div class="section level4">
<h4 id="naming-convention">Naming convention<a class="anchor" aria-label="anchor" href="#naming-convention"></a>
</h4>
<p>All data migrations are assumed to be in OHSI SQL and stored within a
migration folder. For a package this should be
<code>inst/sql/sql_server/migrations</code> (these will also likely have
to be platform specific,
e.g. <code>inst/sql/postgresql/migrations</code>). Inside this folder
only migrations that conform to a regular expression such as
<code>(Migration_[0-9]+)-(.+).sql</code>. Explicitly, this encodes
several things:</p>
<ul>
<li>That the file is a migration and only intended to be executed once
and by a DMM instance</li>
<li>The position in the sequence in which the migration will be executed
(i.e. a natural number)</li>
<li>The string name of the migration</li>
<li>The fact that its an sql file</li>
</ul>
<p>For example, the following file names will work:</p>
<pre><code><span><span class="va">Migration_2</span><span class="op">-</span><span class="va">MyMigration.sql</span></span>
<span><span class="va">Migration_2</span><span class="op">-</span><span class="va">v3.2whaterver.sql</span></span>
<span><span class="va">Migration_4</span><span class="op">-</span><span class="va">TEST.sql</span></span>
<span><span class="va">Migration_4</span><span class="op">-</span><span class="fl">2018922</span><span class="op">-</span><span class="va">vAAAA.sql</span></span></code></pre>
<p>However, the following would be invalid:</p>
<pre><code><span><span class="va">MyMigration.sql</span> <span class="co"># Does not include Migration_1</span></span>
<span><span class="va">Migration_2v3.2whaterver.sql</span> <span class="co"># missing -</span></span>
<span><span class="op">-</span><span class="va">TEST_Migration_1.sql</span> <span class="co"># Wrong order</span></span>
<span><span class="va">Migraton_4</span><span class="op">-</span><span class="va">a.sql</span> <span class="co"># Migration spelt wrong</span></span></code></pre>
<p>The <code>check()</code> call within the DMM should validate these.
Package/module maintainers should also ensure that migrations conform to
this by adding a unit test.</p>
</div>
<div class="section level4">
<h4 id="required-parameters">Required parameters<a class="anchor" aria-label="anchor" href="#required-parameters"></a>
</h4>
<p>Any table names or other variables should be set using the SqlRender
parameter <code>{DEFAULT @table_name = my_table_name}</code>. The script
will have the variables:</p>
<pre><code>@results_schema
@table_prefix</code></pre>
<p>The use of <code>@table_prefix</code> when referencing tables is
crucial. However, in general use of parameters is not seen as necessary
at this time. (NOTE: I’m not sure how we would handle parameterized
migrations, or if this is even desirable. Users can manage this with the
<code>DEFAULT</code> keyword in SqlRender)</p>
</div>
<div class="section level4">
<h4 id="example-sql">Example SQL<a class="anchor" aria-label="anchor" href="#example-sql"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">-- changes incidence_rate.person_years from bigint to float</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>{<span class="kw">DEFAULT</span> @migration <span class="op">=</span> migration}</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>{<span class="kw">DEFAULT</span> @incidence_rate <span class="op">=</span> incidence_rate}</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>{<span class="kw">DEFAULT</span> @table_prefix <span class="op">=</span> <span class="st">''</span>}</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> @results_schema.@table_prefix@incidence_rate <span class="kw">ALTER</span> <span class="kw">COLUMN</span> person_years <span class="dt">FLOAT</span>;</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="adding-script-to-list-of-executed-migrations">Adding script to list of executed migrations<a class="anchor" aria-label="anchor" href="#adding-script-to-list-of-executed-migrations"></a>
</h4>
<p>Following a migration the following SQL will execute:</p>
<pre><code>INSERT INTO @results_schema.@table_prexif@migration (migration_completed, migration_order)
    VALUES ('&lt;fileName&gt;', &lt;order&gt;);</code></pre>
<p>(Note - this should be completed automatically by the manager
class)</p>
</div>
</div>
<div class="section level3">
<h3 id="results-data-model-class">Results Data model class<a class="anchor" aria-label="anchor" href="#results-data-model-class"></a>
</h3>
<ul>
<li>Take a connection</li>
<li>handle queries for pooled or non-pooled connections</li>
<li>Common getter methods</li>
<li>Getting the current data model version for use in shiny apps and
reporting tools</li>
</ul>
</div>
<div class="section level3">
<h3 id="utilities">Utilities<a class="anchor" aria-label="anchor" href="#utilities"></a>
</h3>
<p>It is desirable, but not a hard requirement for the initial package
version, to have the following helper utilities.</p>
<div class="section level4">
<h4 id="add-migration-function">Add migration function<a class="anchor" aria-label="anchor" href="#add-migration-function"></a>
</h4>
<p>To provide the ability to add a new migration to an existing
project</p>
</div>
<div class="section level4">
<h4 id="create-ddl-design">Create DDL design<a class="anchor" aria-label="anchor" href="#create-ddl-design"></a>
</h4>
<p>Function to create a ddl csv that conforms to common standards</p>
</div>
<div class="section level4">
<h4 id="create-new-ddl">Create new DDL<a class="anchor" aria-label="anchor" href="#create-new-ddl"></a>
</h4>
<p>In principle this could be added for new projects that will generate
results. However, this may be of limited use.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="limitations-and-scope">Limitations and scope<a class="anchor" aria-label="anchor" href="#limitations-and-scope"></a>
</h2>
<p>This package will not be able to support the following:</p>
<ul>
<li>New features (e.g. an entirely new table) cannot be added to old
results - handling the case where results do not exist should be
downstream of this package</li>
<li>Down migrations for existing data models</li>
<li>Backup management - this utility may support immutable changes to
data that may go wrong. It is up to individual organisations to manage
their data backups through taking necessary steps to mitigate data
loss</li>
<li>Perform transformations to data in R or other software functions -
this package will not support data manipulation methods that are handled
in R; just the structure of the ddl. If manipulations in R are required,
this should be handled through the package functions.</li>
<li>This is not intended to manage changes to OHDSI vocabularies or
CDMs!</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jamie Gilbert.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
