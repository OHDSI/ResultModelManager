<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creating Migrations • ResultModelManager</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Creating Migrations">
<meta property="og:description" content="ResultModelManager">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ResultModelManager</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CreatingMigrations.html">Creating Migrations</a>
    </li>
    <li>
      <a href="../articles/PackageDesign.html">Package Design</a>
    </li>
    <li>
      <a href="../articles/UsingConnectionHandlers.html">Using Connection Handlers</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Creating Migrations</h1>
                        <h4 data-toc-skip class="author">James P.
Gilbert</h4>
            
            <h4 data-toc-skip class="date">2022-09-09</h4>
      
      
      <div class="hidden name"><code>CreatingMigrations.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Migrating existing data models can be a tricky process that often
creates incompatibility between result viewers and existing result sets.
This guide aims to show how to use the <code>ResultModelManager</code>
class to create migrations for a given result model, either using a
package or file structure. Please see the <a href="https://ohdsi.github.io/hades" class="external-link">HADES library</a> for more
information on HADES packages.</p>
</div>
<div class="section level2">
<h2 id="assumptions">Assumptions<a class="anchor" aria-label="anchor" href="#assumptions"></a>
</h2>
<p>This package assumes that you are familiar with R and OHDSI Hades
packages in general. These examples make use of
<code>DatabaseConnector</code> and <code>SqlRender</code>. The
management of data integrity is left to the user, migrations should be
designed and tested before deployment. Steps to maintain the data (such
as backup plans) should be made prior to performing migrations in case
of data corruption.</p>
</div>
<div class="section level2">
<h2 id="creating-the-required-file-structure">Creating the required file structure<a class="anchor" aria-label="anchor" href="#creating-the-required-file-structure"></a>
</h2>
<p>The first step is creating a proper folder structure for migrations.
The chosen path is dependent on the structure used, the most consistent
and recommended way is to expose a function within an R package to allow
users to upgrade a data model. However, a flat folder structure that
does not require an R package to be installed is also supported.</p>
<div class="section level3">
<h3 id="in-an-r-package">In an R package<a class="anchor" aria-label="anchor" href="#in-an-r-package"></a>
</h3>
<p>Data migrations should exist in an isolated folder within the
<code>/inst/sql/</code> directory of a package. The recommended
convention is to use <code>migrations</code> across all Hades package.
As migrations are supported by multiple database platforms this folder
should exist within the generic (and SqlRender OHDSI common sql)
<code>sql_server</code> folder,
<code>inst/sql/sql_server/migrations</code>. For any database specific
migrations they should be in the approprate sub directory. For
example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">inst/sql/</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_server/migrations/Migration_1-create.sql</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sqlite/migrations/Migration_1-create.sql</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">redshift/migrations/Migration_1-create.sql</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-folder-structure">Using folder structure<a class="anchor" aria-label="anchor" href="#using-folder-structure"></a>
</h3>
<p>A folder structure requires a slightly different set up. Here, the
migrations should be split via database platform within the
<code>migration</code> path. For example.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">migrations/</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_server/Migration_1-create.sql</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sqlite/Migration_1-create.sql</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">redshift/Migration_1-create.sql</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="adding-a-migration">Adding a migration<a class="anchor" aria-label="anchor" href="#adding-a-migration"></a>
</h2>
<p>All data migrations are assumed to be in OHSI SQL and stored within a
migration folder (see above for set up). Inside this folder only
migrations that conform to a regular expression such as
<code>(Migration_[0-9]+)-(.+).sql</code>. Explicitly, this encodes
several things:</p>
<ul>
<li>That the file is a migration and only intended to be executed once
and by a DMM instance</li>
<li>The position in the sequence in which the migration will be executed
(i.e. a natural number)</li>
<li>The string name of the migration</li>
<li>The fact that its an sql file</li>
</ul>
<p>For example, the following file names will work:</p>
<pre><code><span><span class="va">Migration_2</span><span class="op">-</span><span class="va">MyMigration.sql</span></span>
<span><span class="va">Migration_2</span><span class="op">-</span><span class="va">v3.2whaterver.sql</span></span>
<span><span class="va">Migration_4</span><span class="op">-</span><span class="va">TEST.sql</span></span>
<span><span class="va">Migration_4</span><span class="op">-</span><span class="fl">2018922</span><span class="op">-</span><span class="va">vAAAA.sql</span></span></code></pre>
<p>However, the following would be invalid:</p>
<pre><code><span><span class="va">MyMigration.sql</span> <span class="co"># Does not include Migration_1</span></span>
<span><span class="va">Migration_2v3.2whaterver.sql</span> <span class="co"># missing -</span></span>
<span><span class="op">-</span><span class="va">TEST_Migration_1.sql</span> <span class="co"># Wrong order</span></span>
<span><span class="va">Migraton_4</span><span class="op">-</span><span class="va">a.sql</span> <span class="co"># Migration spelt wrong</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="adding-migrator">Adding migrator<a class="anchor" aria-label="anchor" href="#adding-migrator"></a>
</h2>
<p>Each package/project should expose an instantiated DMM with the
package specfic considerations. For example, for the package
<code>CohortDiagnostics</code> a function such as the following may be
written:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="va">getDataMigrator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">connectionDetails</span>, <span class="va">databaseSchema</span>, <span class="va">tablePrefix</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">ResultModelManager</span><span class="fu">::</span><span class="va"><a href="../reference/DataMigrationManager.html">DataMigrationManager</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>                                               databaseSchema <span class="op">=</span> <span class="va">databaseSchema</span>,</span>
<span>                                               tablePrefix <span class="op">=</span> <span class="va">tablePrefix</span>,</span>
<span>                                               migrationPath <span class="op">=</span> <span class="st">"migrations"</span>,</span>
<span>                                               packageName <span class="op">=</span> <span class="st">"CohortDiagnostics"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This will return an instance of data migrator that will expose teh
functionality on a given data set. Naturally, the package is not
strictly required for creating a migration manager (should the directory
structure conform to the above outline) here you should set it according
to your project’s set up.</p>
<p>Loading the migrator is then straightforward:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">createConnectionDetails</a></span><span class="op">(</span><span class="va">MySettings</span><span class="op">)</span></span>
<span><span class="va">migrator</span> <span class="op">&lt;-</span> <span class="fu">getDataMigrator</span><span class="op">(</span>connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>, databaseSchema <span class="op">=</span> <span class="st">"mySchema"</span>, tablePrefix <span class="op">=</span> <span class="st">"cd_"</span><span class="op">)</span></span></code></pre></div>
<p>To check migrations are valid</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">migrator</span><span class="op">$</span><span class="fu">check</span><span class="op">(</span><span class="op">)</span> <span class="co"># Will return false and display any eronious files</span></span></code></pre></div>
<p>To get the status of all migrations</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">migrator</span><span class="op">$</span><span class="fu">getStatus</span><span class="op">(</span><span class="op">)</span> <span class="co"># Will return data frame of all sql migrations and if they have been executed or not</span></span></code></pre></div>
<p>To run the migrations:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## It is strongly recommended that you create some form of backup before doing this</span></span>
<span><span class="va">migrator</span><span class="op">$</span><span class="fu">executeMigrations</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="unit-testing">Unit testing<a class="anchor" aria-label="anchor" href="#unit-testing"></a>
</h2>
<p>No specific advice is given for how to write unit tests for
migrations, however, it is strongly advised that migrations are unit
tested.</p>
</div>
<div class="section level2">
<h2 id="common-issues">Common issues<a class="anchor" aria-label="anchor" href="#common-issues"></a>
</h2>
<p>The following is a list of expected issues when handling Data
migrations:</p>
<div class="section level3">
<h3 id="supporting-all-database-platforms">Supporting all database platforms<a class="anchor" aria-label="anchor" href="#supporting-all-database-platforms"></a>
</h3>
<p>It is likely a challenge to support all
<code>SqlRender/DatabaseConnector</code> supported dbmses. Therefore,
careful consideration with regards to supported platforms should be
made. At the time of writing, for results handling, we recommend
supporting the open source platforms of SqlRender and Postgresql. This
decision is left to the package author.</p>
</div>
<div class="section level3">
<h3 id="sqlite-column-types">SQLite column types<a class="anchor" aria-label="anchor" href="#sqlite-column-types"></a>
</h3>
<p>It is a not possible to change a data type within an Sqlite table
(the <code>ALTER TABLE</code> command does not work). Consequently, you
will likely have to rename the existing table, create a new table with
the modified DDL and then copy the existing data across (using
appropriate data transformations/casting).</p>
<p>For example, changing an <code>INT</code> column in the table
<code>foo</code> to a float requires the sqlite specific
transformation:</p>
<pre class="{sqlite-sql}"><code>{DEFAULT @foo = foo}

ALTER TABLE @database_schema.@table_prefix@foo RENAME TO _foo_old;

CREATE TABLE @database_schema.@table_prefix@foo (
    id bigint,
    foo float
);

INSERT INTO @database_schema.@table_prefix@foo (id, foo)
SELECT * FROM _foo_old;</code></pre>
</div>
<div class="section level3">
<h3 id="non-existent-data">Non-existent data<a class="anchor" aria-label="anchor" href="#non-existent-data"></a>
</h3>
<p>The presence of a data model does not mean data is present. As
packages are developed, it is expected that new data formats will be
created. The recommended pattern for this case is to allow existing data
to be upgraded but to handle the use case of missing data in downstream
reports/web applications.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by James Gilbert.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
