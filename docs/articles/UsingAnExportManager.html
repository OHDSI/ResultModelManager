<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using An Export Manager • ResultModelManager</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using An Export Manager">
<meta property="og:description" content="ResultModelManager">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ResultModelManager</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CreatingMigrations.html">Creating Migrations</a>
    </li>
    <li>
      <a href="../articles/ExampleProject.html">Example package results spec</a>
    </li>
    <li>
      <a href="../articles/PackageDesign.html">Package Design</a>
    </li>
    <li>
      <a href="../articles/UploadFunctionality.html">Upload Functionality</a>
    </li>
    <li>
      <a href="../articles/UsingAnExportManager.html">Using An Export Manager</a>
    </li>
    <li>
      <a href="../articles/UsingConnectionHandlers.html">Using Connection Handlers</a>
    </li>
    <li>
      <a href="../articles/UsingQueryNamespaces.html">Using Query Namespaces</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using An Export Manager</h1>
                        <h4 data-toc-skip class="author">James P.
Gilbert</h4>
            
            <h4 data-toc-skip class="date">2023-12-14</h4>
      
      
      <div class="hidden name"><code>UsingAnExportManager.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>OHDSI studies often have very specific requirements in terms of
exposing patient details.</p>
</div>
<div class="section level2">
<h2 id="creating-the-export-manager-for-a-package">Creating the export manager for a package<a class="anchor" aria-label="anchor" href="#creating-the-export-manager-for-a-package"></a>
</h2>
<p>The table Specification must be definied for a table to be exported.
Crucially, the data types, column names, primary keys and valid settings
are always validated at the time of export. You cannot export data that
does not conform to this model, so make sure that this model matches the
result schema that the data are being imported in to. It is assumed that
package developers will include this in the unit tests of their
package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ResultModelManager</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tableSpecification</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  tableName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"my_table"</span>, <span class="st">"my_table"</span>, <span class="st">"my_table"</span>, <span class="st">"my_table"</span>, <span class="st">"my_table"</span>, <span class="st">"my_table"</span>, <span class="st">"my_table"</span>,</span>
<span>    <span class="st">"my_andromeda_table"</span>, <span class="st">"my_andromeda_table"</span>, <span class="st">"my_andromeda_table"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  columnName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"database_id"</span>, <span class="st">"target_cohort_id"</span>, <span class="st">"comparator_cohort_id"</span>, <span class="st">"target_count"</span>, <span class="st">"comparator_count"</span>, <span class="st">"rr"</span>, <span class="st">"p_value"</span>,</span>
<span>    <span class="st">"database_id"</span>, <span class="st">"covariate_id"</span>, <span class="st">"value"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  primaryKey <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"yes"</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>, <span class="st">"no"</span>, <span class="st">"no"</span>, <span class="st">"no"</span>, <span class="st">"no"</span>,</span>
<span>    <span class="st">"yes"</span>, <span class="st">"yes"</span>, <span class="st">"no"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  minCellCount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"no"</span>, <span class="st">"no"</span>, <span class="st">"no"</span>, <span class="st">"yes"</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>, <span class="st">"no"</span>,</span>
<span>    <span class="st">"no"</span>, <span class="st">"no"</span>, <span class="st">"no"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  dataType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"varchar(255)"</span>, <span class="st">"int"</span>, <span class="st">"int"</span>, <span class="st">"int"</span>, <span class="st">"int"</span>, <span class="st">"float"</span>, <span class="st">"float"</span>,</span>
<span>    <span class="st">"varchar(255)"</span>, <span class="st">"bigint"</span>, <span class="st">"float"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Per database export folder is a good principle to follow</span></span>
<span><span class="va">exportDir</span> <span class="op">&lt;-</span> <span class="st">"output_folder/example_cdm"</span></span>
<span><span class="va">exportManager</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createResultExportManager.html">createResultExportManager</a></span><span class="op">(</span></span>
<span>  tableSpecification <span class="op">=</span> <span class="va">tableSpecification</span>,</span>
<span>  exportDir <span class="op">=</span> <span class="va">exportDir</span>,</span>
<span>  databaseId <span class="op">=</span> <span class="st">"example_cdm"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="saving-large-results-sets-with-a-batch-operation">Saving large results sets with a batch operation<a class="anchor" aria-label="anchor" href="#saving-large-results-sets-with-a-batch-operation"></a>
</h2>
<p>As data sets can easily exceed system memory, any operations should
be performed in batch (via the export manager’s exposed functions with a
callback), or exporting from an Andromeda object.</p>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>First we will connect to a test database and create some test
data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connection</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span>server <span class="op">=</span> <span class="st">":memory:"</span>, dbms <span class="op">=</span> <span class="st">"sqlite"</span><span class="op">)</span></span>
<span><span class="va">schema</span> <span class="op">&lt;-</span> <span class="st">"main"</span></span>
<span></span>
<span><span class="co"># Some made up counts</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  target_cohort_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>  comparator_cohort_id <span class="op">=</span> <span class="fl">101</span><span class="op">:</span><span class="fl">200</span>,</span>
<span>  target_count <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">100</span>, lambda <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  target_time <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100000</span><span class="op">)</span>,</span>
<span>  comparator_count <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">100</span>, lambda <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  comparator_time <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100000</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/insertTable.html" class="external-link">insertTable</a></span><span class="op">(</span><span class="va">connection</span>, data <span class="op">=</span> <span class="va">data</span>, tableName <span class="op">=</span> <span class="st">"result_table"</span>, databaseSchema <span class="op">=</span> <span class="va">schema</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exporting-a-database-query-result">Exporting a database query result<a class="anchor" aria-label="anchor" href="#exporting-a-database-query-result"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="st">"SELECT * FROM @schema.result_table"</span></span>
<span><span class="va">exportManager</span><span class="op">$</span><span class="fu">exportQuery</span><span class="op">(</span>connection <span class="op">=</span> <span class="va">connection</span>, sql <span class="op">=</span> <span class="va">sql</span>, exportTableName <span class="op">=</span> <span class="st">"my_table"</span>, schema <span class="op">=</span> <span class="va">schema</span><span class="op">)</span></span></code></pre></div>
<p>It is vital to ensure that the returned result set conforms to your
data model, including the primary key columns specified. Otherwise,
export validation will fail to prevent errors in exported csv files.</p>
<p>If you look at the file
<code>output_folder/example_cdm/my_table.csv</code> you will notice that
the database_id field is populated, you should not add this in SQL as it
will be completed per database automatically.</p>
<p>Note that this result set is incomplete - we’re not exporting fields
that would be computed using an R function, just the values that are
exported from an sql query.</p>
<div class="section level4">
<h4 id="performing-r-operations">Performing R operations<a class="anchor" aria-label="anchor" href="#performing-r-operations"></a>
</h4>
<p>In order to perform R operations (for example, computing a rate ratio
or p-value that would be difficult to compute in SQL) it is recommended
that is performed inside a callback function to the
<code>exportQuery</code> method. Modifying the above to include a rate
ratio calculation using the <code>rateratio.test</code> package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rateratio.test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">transformation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">rows</span>, <span class="va">pos</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rrResult</span> <span class="op">&lt;-</span> <span class="fu">rateratio.test</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">row</span><span class="op">$</span><span class="va">target_count</span>, <span class="va">row</span><span class="op">$</span><span class="va">comparator_count</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">row</span><span class="op">$</span><span class="va">target_time</span>, <span class="va">row</span><span class="op">$</span><span class="va">comparator_time</span><span class="op">)</span>,</span>
<span>    RR <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    conf.level <span class="op">=</span> <span class="fl">0.95</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">row</span><span class="op">$</span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="va">rrResult</span><span class="op">$</span><span class="va">estimate</span></span>
<span>  <span class="va">row</span><span class="op">$</span><span class="va">p_value</span> <span class="op">&lt;-</span> <span class="va">rrResult</span><span class="op">$</span><span class="va">p.value</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">row</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">exportManager</span><span class="op">$</span><span class="fu">exportQuery</span><span class="op">(</span><span class="va">connection</span>,</span>
<span>  <span class="va">sql</span>,</span>
<span>  <span class="st">"my_table"</span>,</span>
<span>  transformFunction <span class="op">=</span> <span class="va">transformation</span>,</span>
<span>  transformFunctionArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  append <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  schema <span class="op">=</span> <span class="va">schema</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="exporting-an-andromeda-result-in-batch">Exporting an Andromeda result in batch<a class="anchor" aria-label="anchor" href="#exporting-an-andromeda-result-in-batch"></a>
</h3>
<p>It is generally inadvisable to collect an entire andromeda table for
export in to the R session before saving to disk. Instead, it is best
practice to use batch operations as follows</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">andr</span> <span class="op">&lt;-</span> <span class="fu">Andromeda</span><span class="fu">::</span><span class="fu">andromeda</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">andr</span><span class="op">$</span><span class="va">my_andromeda_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>covariate_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1e4</span>, value <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1e4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">first</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="va">writeBatch</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">exportManager</span><span class="op">$</span><span class="fu">exportDataFrame</span><span class="op">(</span><span class="va">batch</span>, <span class="st">"my_andromeda_table"</span>, append <span class="op">=</span> <span class="va">first</span><span class="op">)</span></span>
<span>  <span class="va">first</span> <span class="op">&lt;&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="co"># we don't want to return anything, just write the result to disk</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">Andromeda</span><span class="fu">::</span><span class="fu">batchApply</span><span class="op">(</span><span class="va">andr</span><span class="op">$</span><span class="va">my_andromeda_table</span>, <span class="va">writeBatch</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="creating-a-results-manifest-file">Creating a results manifest file<a class="anchor" aria-label="anchor" href="#creating-a-results-manifest-file"></a>
</h2>
<p>Export manifests contain an sha256 hash of all files exported. This
can be useful to see if a file was modified or corrupted before
inclusion. To export the manifest of files within an export
directory:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exportManger</span><span class="op">$</span><span class="fu">writeManifest</span><span class="op">(</span>packageName <span class="op">=</span> <span class="st">"analytics_package"</span>, packageVersion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"analytics_package"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jamie Gilbert.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
